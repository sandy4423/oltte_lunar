# PRD: 설날 떡국용 만두 단지 배달(문앞) 사전주문 시스템
- **작성일:** 2026-01-22
- **배포:** Vercel
- **DB:** Supabase (Postgres)
- **결제:** PortOne V2 (가상계좌 메인, 카드 옵션)
- **운영기간:** 마지막 배송일 2026-02-13(금)

## 1. 목표
전단지(QR)로 유입된 고객이 “쉽게 계좌이체처럼 결제”할 수 있게 만들고, 운영자는 “입금확정/마감취소/집계/라벨/배송완료문자”를 자동화하여 10개 단지를 무리 없이 완주한다.

### 핵심 성공 조건
1. 50대 이상이 헤매지 않고 결제 완료 (가상계좌 안내 SMS + 최소 클릭)
2. 단지별 D-2 23:00 마감이 자동으로 지켜짐 (미입금 자동취소 + 가상계좌 말소)
3. 운영자가 배송 당일 모바일에서 버튼만 눌러 상태/문자 처리

## 2. 운영 정책
### 2.1 배송 및 마감
- **배송:** 시간대 지정 불가, 당일 순차 문앞 배송(비대면).
- **마감:** 배송일 기준 **D-2 23:00** (모든 단지 공통 고정).
- **취소/환불:** 입금 전 자동취소. 입금 후 취소 불가(예외 없음). 시스템상 자동환불 미구현(수기 대응).

### 2.2 무료배송/최소주문
- **조건:** 총 수량(아이템 수) 합계가 **3개 이상**이어야 결제 가능.
- **안내 문구:** "무료배송 최소 3개 = 만두 3팩 또는 만두 2팩 + 떡국떡 1kg"

## 3. 상품 구성
- **떡국용 만두:** 고기 / 김치 / 반반
  - 가격: 1팩 10,000원 (기존 11,000원 → 배송 특가)
  - 사양: 1팩 8개, 총중량 약 450g
- **추가상품:** 떡국떡 1kg (10,000원)

## 4. 단지별 일정 (Parameter: `apt`)
*URL 예시: `/order?apt=8_oceanpark`*

| 순번 | 파라미터(`apt`) | 단지명 | 배송일(요일) | 주문마감(D-2 23:00) |
|:---:|---|---|---|---|
| 1 | `8_oceanpark` | 8공구 송도 오션파크 베르디움 | 01-31(토) | 01-29(목) 23:00 |
| 2 | `8_hoban` | 8공구 호반써밋 송도 | 02-01(일) | 01-30(금) 23:00 |
| 3 | `8_skview` | 8공구 송도 SK뷰 | 02-02(월) | 01-31(토) 23:00 |
| 4 | `8_ephyun` | 8공구 e편한세상 송도 | 02-03(화) | 02-01(일) 23:00 |
| 5 | `8_landmark` | 8공구 랜드마크시티 센트럴 더샵 | 02-04(수) | 02-02(월) 23:00 |
| 6 | `6_hill_12` | 6공구 힐스테이트 레이크 1+2차 | 02-06(금) | 02-04(수) 23:00 |
| 7 | `6_hill_3` | 6공구 힐스테이트 레이크 3차 | 02-07(토) | 02-05(목) 23:00 |
| 8 | `6_lux` | 6공구 송도 럭스오션 SK뷰 | 02-09(월) | 02-07(토) 23:00 |
| 9 | `6_xi_crystal` | 6공구 송도 자이 크리스탈오션 | 02-11(수) | 02-09(월) 23:00 |
| 10 | `6_xi_star` | 6공구 자이 더 스타 | 02-13(금) | 02-11(수) 23:00 |

## 5. UI/UX 및 문구 가이드
### 5.1 전단지/랜딩 문구
- **메인:** "설 만두는 제가 빚을게요"
- **서브:** "설날 만두와 떡국. 문앞까지 직접 배달합니다."
- **안전장치:** "선착순 / 1가구 1회 / 조기 소진 가능"

### 5.2 카톡/문자 공유 시 (User Context)
- 카톡 공유하기 기능 구현 시, 텍스트는 유니코드 기반으로 이쁘게 꾸며서 전송되도록 처리.

### 5.3 결제 화면 UX
- **컨셉:** "문자에 계좌번호가 바로 오는 방식"을 기본으로 노출.
- **카드 결제:** "카드로 바로 결제하기" 버튼은 하단에 옵션으로 배치.

## 6. 시스템 기능 요구사항
### 6.1 고객 플로우 (Frontend)
1. **진입:** QR 스캔 → `/order?apt=...` 진입.
2. **인증:** 휴대폰 번호 입력 및 **OTP 인증** (오입력 방지 필수).
3. **주문:** 상품 선택 (3개 미만 결제 불가).
4. **결제:**
   - (기본) 가상계좌 발급 → 화면 표시 + SMS 전송.
   - (옵션) 카드 결제 → 포트원 결제창 호출.

### 6.2 백엔드 로직 (Backend)
1. **가상계좌 발급:**
   - PortOne API 호출 시 `valid_until`을 해당 단지의 `cutoff_at`으로 설정.
2. **입금 확정 (Webhook):**
   - PortOne V2 `payment.succeeded` 웹훅 수신.
   - 시그니처 검증 및 멱등성 체크 후 `status = PAID` 변경.
   - 카드 결제 성공 시, 기 발급된 가상계좌가 있다면 즉시 말소 API 호출.
3. **마감 자동화 (Cron):**
   - 10분 단위 실행.
   - `cutoff_at` 경과 && `WAITING_FOR_DEPOSIT` 상태인 주문 → `AUTO_CANCELED` 처리.
   - 동시에 가상계좌 말소 API 호출하여 입금 차단.

### 6.3 어드민 (Admin)
- **기능:** 단지/배송일별 주문 필터링, 엑셀 다운로드.
- **상태 변경:** 입금대기/확정/취소/배송중/배송완료.
- **라벨 출력:** 40x30mm 규격 PDF 생성 또는 브라우저 인쇄 최적화 (CSS `@media print`).
- **원클릭 문자:**
   - "배송중" 버튼: 일괄 문자 발송.
   - "배송완료" 버튼: 개별 문자 발송.

## 7. SMS 발송 정책
- **필수:** 가상계좌 안내, 입금 확정, 배송 출발, 배송 완료.
- **내용 참조:** "배송완료" 문자 발송 시, **김치만두(매운맛)**가 포함된 주문에는 *"속 쓰림 주의 에피소드"* 멘트를 조건부로 포함할 수 있도록 로직 마련.

## 8. 데이터 모델 참조 (간략)
- 상세 구조는 `schema.sql`을 따른다.
- **주요 테이블:** `customers`, `orders`, `order_items`, `audit_logs`